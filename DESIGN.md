# 設計書: 習慣トラッキングアプリ

## 1. アプリケーション概要

### 1.1. 目的
日々の習慣（ルーティン、筋トレ内容、体調など）を記録し、その履歴を表やグラフで可視化することで、習慣化をサポートする。

### 1.2. 利用者
個人利用を想定。

### 1.3. プラットフォーム
デスクトップアプリケーション (macOS, Windows, Linux で動作可能)。

## 2. コア機能

*   **チェックリスト入力:** ユーザーが定義したチェックリストに従って、日々の記録を入力する。
*   **回答履歴表示:** 過去の入力履歴を表形式で表示する。日付や回答内容によるフィルタリング、日付によるソートが可能。特定の日の回答を削除する機能を持つ。
*   **チェックリスト編集:** チェックリストのタイトル、説明、設問（テキスト、タイプ、選択肢、数値制限、ランダム順序設定）を編集する。設問の追加、削除、並び替えが可能。
*   **グラフ表示:** 回答履歴をもとに、各設問の傾向をグラフで可視化する。
    *   Yes/No: 直近7回答の Yes 率の推移（折れ線グラフ）
    *   n択: 直近7回答の各選択肢の選択確率の推移（複数折れ線グラフ）
    *   数値: 日々の値の推移（折れ線グラフ、表示期間選択可能）
*   **データ管理:**
    *   **永続化:** チェックリスト設定と回答履歴をローカルの JSON ファイルに保存する。
    *   **インポート/エクスポート:** アプリケーションデータ（チェックリスト設定と回答履歴）を単一の JSON ファイルとして書き出し（エクスポート）、読み込み（インポート）する。インポート時は既存データを上書きする。

## 3. アーキテクチャ

### 3.1. 技術スタック
*   **フレームワーク:** Electron (デスクトップアプリ化)
*   **UI ライブラリ:** React
*   **ビルドツール:** Vite
*   **グラフ描画:** Recharts
*   **日付操作:** date-fns
*   **ID生成:** uuid

### 3.2. プロセスモデル
*   **メインプロセス (`src/main/main.js`):** アプリケーションのライフサイクル管理、ウィンドウ作成、ネイティブ機能（ファイルシステムアクセス、ダイアログ表示）の提供、IPC (プロセス間通信) によるレンダラープロセスとの連携。
*   **レンダラープロセス (`src/renderer/`):** React アプリケーションとして UI を描画・操作。メインプロセスとは `preload.js` を介して安全に通信する (`contextBridge`)。

### 3.3. データストレージ
*   **場所:** Electron の `app.getPath('userData')` で取得されるディレクトリ内。
*   **ファイル名:** `routineData.json`
*   **形式:** JSON

## 4. データ構造 (`routineData.json`)

```json
{
  "checklist": {
    "id": "unique-checklist-id", // UUID
    "title": "チェックリストのタイトル",
    "description": "チェックリストの説明 (任意)",
    "updatedAt": "ISO8601 Timestamp",
    "questions": [
      {
        "id": "unique-question-id-1", // UUID
        "text": "質問文",
        "type": "yes_no" | "multiple_choice" | "number" | "free_text",
        "options": ["選択肢1", "選択肢2"], // multiple_choice の場合
        "validation": { // number の場合 (任意)
          "min": 0,
          "max": 100,
          "integer": true
        },
        "randomOrder": { // ランダム順序設定 (任意)
          "enabled": true | false,
          "range": { "start": 1, "end": 5 }, // n問目からm問目 (任意)
          "position": "last" // "last" など (任意、range とは排他)
        },
        "orderIndex": 0 // 並び替え用のインデックス
      },
      // ... more questions
    ]
  },
  "history": [
    {
      "checklistId": "unique-checklist-id", //どのチェックリストに対する回答か
      "checklistTitle": "回答時のチェックリストタイトル",
      "submittedAt": "ISO8601 Timestamp", // 回答完了日時 (主キーとして利用)
      "answers": {
        "unique-question-id-1": "yes" | "選択肢1" | 100 | "自由記述内容",
        "unique-question-id-2": "no"
        // ... answers for other questions
      },
      "duration": 12345 // 回答にかかった時間 (ミリ秒、任意)
    },
    // ... more history entries
  ]
}
```

## 5. 画面構成

*   **メインウィンドウ:** サイドバーナビゲーションとメインコンテンツエリアで構成。
*   **サイドバー:**
    *   各画面へのナビゲーションリンク (チェックリスト入力, 回答履歴, チェックリスト編集, グラフ)
    *   データ操作ボタン (インポート, エクスポート)
*   **メインコンテンツエリア:** 現在選択されている画面を表示。
    *   **チェックリスト入力画面 (`ChecklistScreen`):**
        *   現在のチェックリストのタイトルと説明を表示。
        *   定義された（またはランダム化された）順序で質問を一つずつ表示。
        *   進捗バーを表示。
        *   各質問タイプに応じた入力フィールド（ラジオボタン、セレクトボックス、数値入力、テキストエリア）を表示。
        *   数値入力時のバリデーション（最小値、最大値、整数）。
        *   「次へ」/「完了」ボタンで進行し、完了時に回答を保存。
        *   チェックリスト未作成時は編集画面への導線を表示。
    *   **回答履歴画面 (`HistoryScreen`):**
        *   フィルターエリア（日付範囲、各質問の回答内容）。
        *   回答履歴を表形式で表示（列: 回答日時、各質問）。
        *   回答日時でのソート機能（昇順/降順）。
        *   各行に削除ボタンを表示。
        *   表の内容がはみ出す場合は横スクロールで表示。設問・回答は全文表示、改行なし。
    *   **チェックリスト編集画面 (`EditScreen`):**
        *   チェックリストのタイトル、説明を編集。
        *   質問リストを表示・編集。
            *   質問テキスト、タイプ、選択肢（n択）、数値制限、ランダム順序設定を編集。
            *   質問の追加、削除、上下への並び替え。
        *   「保存」ボタンで変更を `routineData.json` に保存。
        *   「キャンセル」ボタンで変更を破棄して入力画面へ戻る。
    *   **グラフ画面 (`GraphScreen`):**
        *   グラフ化可能な質問（Yes/No, n択, 数値）ごとにグラフを表示。
        *   Yes/No: 直近7回答の Yes 率推移（折れ線）。
        *   n択: 直近7回答の各選択肢の選択確率推移（複数折れ線）。
        *   数値: 日々の値の推移（折れ線）。数値グラフのみ表示期間（直近1ヶ月、3ヶ月等）を選択可能。
        *   データ不足時はメッセージを表示。

## 6. 主要ロジック詳細

*   **質問順序決定 (`ChecklistScreen`):**
    *   `randomOrder` 設定に基づき、固定位置（最後）、範囲指定、それ以外の質問を組み合わせて最終的な表示順序を決定する。範囲指定内で競合する場合はランダムに配置。
*   **データ I/O (`main.js`, `preload.js`, `App.jsx`):**
    *   メインプロセスが `fs` モジュールで `routineData.json` を読み書き。
    *   レンダラープロセスは `preload.js` 経由で公開された API (`electronAPI.loadData`, `saveData` 等) を呼び出し、メインプロセスに処理を依頼。
    *   インポート/エクスポートはメインプロセスの `dialog` モジュールを使用。インポート成功時は `webContents.send` でレンダラーに通知。
*   **グラフデータ集計 (`GraphScreen`):**
    *   Yes/No, n択: 回答履歴を日付でソート後、7件ずつのスライディングウィンドウで Yes 率/選択確率を計算。ウィンドウ最後の回答の日付を X 軸とする。
    *   数値: 指定された期間内の回答を日付ごとに集計（同日複数回答の場合は平均値）。
*   **履歴フィルタリング/ソート (`HistoryScreen`):**
    *   `useMemo` を使用し、フィルター条件やソート順が変更された場合のみ再計算。日付範囲、各質問の回答内容で絞り込み、日付でソート。

## 7. ビルドと実行

*   **開発実行:** `npm run dev` (Vite サーバーと Electron を同時に起動)
*   **ビルド:** `npm run build` (Vite でレンダラーをビルド後、`electron-builder` で各 OS 用のパッケージを作成)
*   **パッケージ場所:** `release/` ディレクトリ
*   **実行 (ビルド後):** 各 OS の標準的な方法でインストールし、実行。
